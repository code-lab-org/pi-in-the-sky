<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>pi-in-the-sky</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.85/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
</head>

<body>
  <main role="main" class="container-fluid">
    <div id="cesiumContainer"></div>
  </main>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.85/Build/Cesium/Cesium.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  <script>
  $(document).ready(function(){
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlMGE4YTEyMi0wNzllLTRjYmItYTY3Ny1kOTA3YzEwNzk3ZDEiLCJpZCI6MTYyNzcsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NzAwNjA5MzF9.NgsS6QgAqCD3SkBP23vtQro_QWUDVgUnEEOW-UQ2ypQ';
	var clock = new Cesium.Clock({
				currentTime: Cesium.JulianDate.fromIso8601("1900-01-01"),
				clockStep: Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER,
				multiplier: 0, // how much time to advance each SYSTEM CLOCK tick
				shouldAnimate: false,

			});
	const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      baseLayerPicker: false,
      homeButton: false,
      infoBox: false,
      geocoder: false,
      selectionIndicator: false,
      navigationHelpButton: false,
      navigationInstructionsInitiallyVisible: false,
      timeline: false,
      imageryProvider: new Cesium.IonImageryProvider({ assetId: 3845 }),
	  //clockViewModel: new Cesium.ClockViewModel(clock)
    });
	// <!-- viewer.scene.globe.enableLighting = true; -->

    // create a MQTT client
  	var client = new Paho.MQTT.Client("pi-in-the-sky.code-lab.org", 9001, "");
	var satPath = viewer.entities.add({
		polyline: {
			positions: [],
			width: 5,
			material: Cesium.Color.BLUE,
			show: true
		}
	  })
	var fires = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection()); //<!-- Initialize fires as primitive points since there will be so many -->

    function handleMessage(message) {
      // get the message payload as a string
	  //<!-- console.log(message.payloadString); -->
      var payload = message.payloadString;
      var topic = message.destinationName;
      // try to parse and stringify a JSON string
      try {
	if(topic=="pits/position") {
		// <!-- Cesium suggests using PointPrimitives when have large collection of points, applies to fires -->
      payload = JSON.parse(message.payloadString);
	  var sat_pos = viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(
                payload["geometry"]["coordinates"][0],
                payload["geometry"]["coordinates"][1],
				payload["geometry"]["coordinates"][2]
              ),
              point: {
                pixelSize: 8,
				color: Cesium.Color.BLUE
			  },
              show: true
            });
    } else if(topic=="pits/active_fires") {
         // <!-- Cesium suggests using PointPrimitives when have large collection of points, applies to fires -->
      payload = JSON.parse(message.payloadString);
	  console.log("test");
      fires.add({
      position : new Cesium.Cartesian3.fromDegrees(
        payload["geometry"]["coordinates"][0],
        payload["geometry"]["coordinates"][1]
        ),
      pixelSize: 8,
      color : Cesium.Color.RED,
      show: true
      });
	} else if(topic=="pits/detected_fires") {
         // <!-- Cesium suggests using PointPrimitives when have large collection of points, applies to fires -->
      payload = JSON.parse(message.payloadString);
      fires.add({
      position : new Cesium.Cartesian3.fromDegrees(
        payload["geometry"]["coordinates"][0],
        payload["geometry"]["coordinates"][1]
        ),
      pixelSize: 9,
      color : Cesium.Color.GREEN,
      show: true
      });
	  
		}

	else if(topic=="piTest/constellation/imageTaken"){
		  payload = JSON.parse(message.payloadString);
		  fires.get(payload.floodId).color = Cesium.Color.DARKORANGE
		} else if(topic=="piTest/constellation/imageDownlinked"){
		  payload = JSON.parse(message.payloadString);
		  fires.get(payload.floodId).color = Cesium.Color.YELLOW
		} else if(topic=="piTest/ground/location"){
		  payload = JSON.parse(message.payloadString);
		  activeCheck = payload.operational;
		  if (activeCheck){
			groundColor = Cesium.Color.PINK
			groundMaterial = Cesium.Color.PINK.withAlpha(0.1)
		  } else {
			groundColor = Cesium.Color.LIGHTGRAY
			groundMaterial = Cesium.Color.LIGHTGRAY.withAlpha(0.1)
		  };
		  if (!grounds[payload.groundId]) {
			 // <!-- Only add grounds with unique ids -->
			  grounds[payload.groundId] = viewer.entities.add({
				position: Cesium.Cartesian3.fromDegrees(
					payload.longitude,
					payload.latitude
				),
				point: {
					pixelSize: 8,
					color: groundColor
				},
				show: true
			  });
			// <!-- Currently hardcoded cylinder dimensions, although angle read from message -->
			 commsCones[payload.groundId] = viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(
                payload.longitude,
                payload.latitude,
				100000.0
              ),
			  cylinder: {
				length: 200000.0,
				topRadius: 200000.0*Math.tan((90-payload.elevAngle)*Math.PI/180),
				bottomRadius: 0.0,
				material: groundMaterial,
				outline: true,
				outlineWidth: 1.0,
				}
			});
			}
		}
      } catch(err) {
	  console.log('An error was caught somewhere...')
	  }
    }

    client.connect({
      //"userName": "",
      //"password": "",
      //"useSSL": true,
      "onSuccess": function() {
        client.subscribe("pits/#", {
          "onFailure": function() {
            alert("Error subscribing to topic.");
          },
          "onSuccess": function() {
            client.onMessageArrived = handleMessage;
          }
        });
      }
    });
  });
  </script>
</body>

</html>
